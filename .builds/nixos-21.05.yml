image: nixos/unstable

packages:
  - nixos.cachix

environment:
  NIX_PATH: "nixpkgs=channel:nixos-21.05"
  NUR_REPO: "misterio"
  CACHIX_CACHE: "misterio"
  NIX_CONFIG: "experimental-features = nix-command flakes"

secrets:
  - f2907d38-97b4-4e7d-9fb9-57b3fb0135af

tasks:
- setup_cachix: |
    cat ~/.cachix_token | cachix authtoken --stdin
    cachix use "${CACHIX_CACHE}"
- verify: |
    cd nur-packages
    nix-build ci.nix -A buildOutputs
    nix eval -f default.nix 'lib'
    nix eval -f default.nix 'modules'
    nix eval -f default.nix 'overlays'
    nix-build ci.nix -A cacheOutputs | cachix push "${CACHIX_CACHE}"
- update: |
    curl -XPOST "https://nur-update.herokuapp.com/update?repo=${NUR_REPO}";
